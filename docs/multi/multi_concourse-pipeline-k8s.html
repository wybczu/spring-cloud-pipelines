<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>8.&nbsp;Concourse Pipeline (Kubernetes)</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="multi_spring-cloud-pipelines.html" title="Spring Cloud Pipelines"><link rel="up" href="multi__spring_cloud_pipelines.html" title="Part&nbsp;I.&nbsp;Spring Cloud Pipelines"><link rel="prev" href="multi_concourse-pipeline-cf.html" title="7.&nbsp;Concourse Pipeline (Cloud Foundry)"><link rel="next" href="multi__jenkins_pipeline_common.html" title="9.&nbsp;Jenkins Pipeline (Common)"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">8.&nbsp;Concourse Pipeline (Kubernetes)</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="multi_concourse-pipeline-cf.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;I.&nbsp;Spring Cloud Pipelines</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="multi__jenkins_pipeline_common.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="concourse-pipeline-k8s" href="#concourse-pipeline-k8s"></a>8.&nbsp;Concourse Pipeline (Kubernetes)</h2></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In this chapter, we assume that you deploy your application
to Kubernetes PaaS</p></td></tr></table></div><p><a name="concourse" href="#concourse"></a>The Spring Cloud Pipelines repository contains opinionated
Concourse pipeline definitions. Those jobs form an empty pipeline and an
opinionated sample pipeline that you can use in your company.</p><p>The following projects take part in the <code class="literal">microservice setup</code> for this demo:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes" target="_top">Github Analytics</a>: The application that has a REST endpoint and uses messaging&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a>: Project that emits messages that are used by Github Analytics&#8201;&#8212;&#8201;part of our business application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Eureka</a>: Simple Eureka Server. This is an infrastructure application.</li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot" target="_top">Github Analytics Stub Runner Boot</a>: Stub Runner Boot server to be used for tests with Github Analytics and uses Eureka and Messaging. This is an infrastructure application.</li></ul></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="step-by-step-k8s" href="#step-by-step-k8s"></a>8.1&nbsp;Step-by-step</h2></div></div></div><p>If you want only to run the demo as far as possible by using PCF Dev and Docker Compose, do the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="multi_concourse-pipeline-k8s.html#concourse-fork-k8s">Fork repos</a></li><li class="listitem"><a class="link" href="multi_concourse-pipeline-k8s.html#concourse-start-k8s" title="8.2&nbsp;Concourse in K8S (Kubernetes)">Start Concourse and Artifactory</a></li><li class="listitem"><a class="link" href="multi_concourse-pipeline-k8s.html#concourse-pipeline-fly-k8s" title="8.2.2&nbsp;Setup the fly CLI">Setup the <code class="literal">fly</code> CLI</a></li><li class="listitem"><a class="link" href="multi_concourse-pipeline-k8s.html#concourse-pipeline-credentials-k8s" title="8.2.3&nbsp;Setup your credentials.yml">Setup your <code class="literal">credentials.yml</code></a></li><li class="listitem"><a class="link" href="multi_concourse-pipeline-k8s.html#concourse-pipeline-build-k8s" title="8.2.4&nbsp;Build the pipeline">Setup the pipeline</a></li><li class="listitem"><a class="link" href="multi_concourse-pipeline-k8s.html#concourse-pipeline-run-k8s" title="8.2.5&nbsp;Run the github-webhook Pipeline">Run the <code class="literal">github-webhook</code> pipeline</a></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="fork-repos-k8s" href="#fork-repos-k8s"></a>8.1.1&nbsp;Fork Repositories</h3></div></div></div><p><a name="concourse-fork-k8s" href="#concourse-fork-k8s"></a>Four applications compose the pipeline:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-eureka" target="_top">Github Eureka</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-stub-runner-boot-classpath-stubs" target="_top">Github Stub Runner Boot</a></li></ul></div><p>You need to fork only the following repositories, because only then can you tag and push the tag to the repository:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-webhook-kubernetes" target="_top">Github Webhook</a></li><li class="listitem"><a class="link" href="https://github.com/spring-cloud-samples/github-analytics-kubernetes/" target="_top">Github Analytics</a></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concourse-start-k8s" href="#concourse-start-k8s"></a>8.2&nbsp;Concourse in K8S (Kubernetes)</h2></div></div></div><p>The simplest way to deploy Concourse to K8S is to use <a class="link" href="https://github.com/kubernetes/helm" target="_top">Helm</a>.
Once you have Helm installed and your <code class="literal">kubectl</code> is pointing to the
cluster, run the following command to install the Concourse cluster in your K8S cluster:</p><div class="informalexample"><pre class="programlisting">$ helm install stable/concourse --name concourse</pre></div><p>Once the script is done, you should see the following output</p><div class="informalexample"><pre class="programlisting"><span class="hl-number">1.</span> Concourse can be accessed:

  * Within your cluster, at the following DNS name at port <span class="hl-number">8080</span>:

    concourse-web.default.svc.cluster.local

  * From outside the cluster, run these commands in the same shell:

    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=concourse-web"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
    <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Visit http://127.0.0.1:8080 to use Concourse"</span>
    kubectl port-forward --namespace default $POD_NAME <span class="hl-number">8080</span>:<span class="hl-number">8080</span>

<span class="hl-number">2.</span> Login with the following credentials

  Username: concourse
  Password: concourse</pre></div><p>Follow the steps and log in to Concourse under <a class="link" href="http://127.0.0.1:8080" target="_top">http://127.0.0.1:8080</a>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_deploying_artifactory_to_k8s" href="#_deploying_artifactory_to_k8s"></a>8.2.1&nbsp;Deploying Artifactory to K8S</h3></div></div></div><p>You can use Helm also to deploy Artifactory to K8S, as follows:</p><div class="informalexample"><pre class="programlisting">$ helm install --name artifactory --<span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">set</span> artifactory.image.repository=docker.bintray.io/jfrog/artifactory-oss stable/artifactory</pre></div><p>After you run this command, you should see the following output:</p><div class="informalexample"><pre class="programlisting">NOTES:
Congratulations. You have just deployed JFrog Artifactory Pro!

<span class="hl-number">1.</span> Get the Artifactory URL by running these commands:

   NOTE: It may take a few minutes <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> the LoadBalancer IP to be available.
         You can watch the status of the service by running <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'kubectl get svc -w nginx'</span>
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> SERVICE_IP=$(kubectl get svc --namespace default nginx -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.status.loadBalancer.ingress[0].ip}'</span>)
   <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> http://$SERVICE_IP/

<span class="hl-number">2.</span> Open Artifactory in your browser
   Default credential <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">for</span> Artifactory:
   user: admin
   password: password</pre></div><p>Next, you need to set up the repositories.</p><p>First, access the Artifactory URL and log in with
a user name of <code class="literal">admin</code> and a password of <code class="literal">password</code>.</p><div class="figure"><a name="d0e5067" href="#d0e5067"></a><p class="title"><b>Figure&nbsp;8.1.&nbsp;Click on Quick Setup</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/artifactory_quick_setup.png" alt="artifactory quick setup"></div></div></div><br class="figure-break"><p>Then, click on Maven setup and click <code class="literal">Create</code>.</p><div class="figure"><a name="d0e5081" href="#d0e5081"></a><p class="title"><b>Figure&nbsp;8.2.&nbsp;Create the <code class="literal">Maven</code> Repository</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/artifactory_maven_repo.png" alt="artifactory maven repo"></div></div></div><br class="figure-break"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-fly-k8s" href="#concourse-pipeline-fly-k8s"></a>8.2.2&nbsp;Setup the <code class="literal">fly</code> CLI</h3></div></div></div><p><a name="fly" href="#fly"></a> If you go to the Concourse website you should see something resembling the following:</p><div class="informalfigure"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_concourse.png" alt="running concourse"></div></div><p>You can click one of the icons (depending on your OS) to download <code class="literal">fly</code>, which is the Concourse CLI. Once you download that (and maybe added it to your PATH, depending on your OS) you can run the following command:</p><div class="informalexample"><pre class="programlisting">fly --version</pre></div><p>If <code class="literal">fly</code> is properly installed, it should print out the version.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-credentials-k8s" href="#concourse-pipeline-credentials-k8s"></a>8.2.3&nbsp;Setup your <code class="literal">credentials.yml</code></h3></div></div></div><p>We made a sample credentials file called <code class="literal">credentials-sample-k8s.yml</code>
prepared for <code class="literal">k8s</code>. You can use it as a base for your <code class="literal">credentials.yml</code>.</p><p>To allow the Concourse worker&#8217;s spawned container to connect to the
Kubernetes cluster, you must pass the CA contents and the
auth token.</p><p>To get the contents of CA for GCE, run the following command:</p><div class="informalexample"><pre class="programlisting">$ kubectl get secret $(kubectl get secret | grep default-token | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span>) -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.data.ca\.crt}'</span> | base64 --decode</pre></div><p>To get the auth token, run the following command:</p><div class="informalexample"><pre class="programlisting">$ kubectl get secret $(kubectl get secret | grep default-token | awk <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{print $1}'</span>) -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">'{.data.token}'</span> | base64 --decode</pre></div><p>Set that value under <code class="literal">paas-test-client-token</code>, <code class="literal">paas-stage-client-token</code>, and <code class="literal">paas-prod-client-token</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-build-k8s" href="#concourse-pipeline-build-k8s"></a>8.2.4&nbsp;Build the pipeline</h3></div></div></div><p>After running Concourse, you should get the following output in your terminal:</p><div class="informalexample"><pre class="programlisting">$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">export</span> POD_NAME=$(kubectl get pods --namespace default -l <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"app=concourse-web"</span> -o jsonpath=<span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"{.items[0].metadata.name}"</span>)
$ <span xmlns:d="http://docbook.org/ns/docbook" class="hl-keyword">echo</span> <span xmlns:d="http://docbook.org/ns/docbook" class="hl-string">"Visit http://127.0.0.1:8080 to use Concourse"</span>
$ kubectl port-forward --namespace default $POD_NAME <span class="hl-number">8080</span>:<span class="hl-number">8080</span>
Visit http://<span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">8080</span> to use Concourse</pre></div><p>Log in (for example, for Concourse running at <code class="literal">127.0.0.1</code>&#8201;&#8212;&#8201;if you do not provide any value, <code class="literal">localhost</code> is assumed). If you run this script, it assumes that either <code class="literal">fly</code> is on your <code class="literal">PATH</code> or that it is in the same folder as the script:</p><div class="informalexample"><pre class="programlisting">$ fly -t k8s login -c http://localhost:<span class="hl-number">8080</span> -u concourse -p concourse</pre></div><p>Next, run the following command to create the pipeline:</p><div class="informalexample"><pre class="programlisting">$ ./set_pipeline.sh github-webhook k8s credentials-k8s.yml</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="concourse-pipeline-run-k8s" href="#concourse-pipeline-run-k8s"></a>8.2.5&nbsp;Run the <code class="literal">github-webhook</code> Pipeline</h3></div></div></div><p>The following images show the various steps involved in runnig the <code class="literal">github-webhook</code> pipeline:</p><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5203" href="#d0e5203"></a><p class="title"><b>Figure&nbsp;8.3.&nbsp;Click <code class="literal">Login</code></b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_login.png" alt="concourse login"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5216" href="#d0e5216"></a><p class="title"><b>Figure&nbsp;8.4.&nbsp;Pick <code class="literal">main</code> team</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_team_main.png" alt="concourse team main"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5230" href="#d0e5230"></a><p class="title"><b>Figure&nbsp;8.5.&nbsp;Log in with <code class="literal">concourse</code> user and <code class="literal">concourse</code> password</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_user_pass.png" alt="concourse user pass"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5247" href="#d0e5247"></a><p class="title"><b>Figure&nbsp;8.6.&nbsp;Your screen should look more or less like this</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pipeline.png" alt="concourse pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5258" href="#d0e5258"></a><p class="title"><b>Figure&nbsp;8.7.&nbsp;Unpause the pipeline by clicking in the top lefr corner and then clicking the <code class="literal">play</code> button</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/start_pipeline.png" alt="start pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5272" href="#d0e5272"></a><p class="title"><b>Figure&nbsp;8.8.&nbsp;Click 'generate-version'</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/generate_version.png" alt="generate version"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5283" href="#d0e5283"></a><p class="title"><b>Figure&nbsp;8.9.&nbsp;Click <code class="literal">+</code> sign to start a new build</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/run_pipeline.png" alt="run pipeline"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5297" href="#d0e5297"></a><p class="title"><b>Figure&nbsp;8.10.&nbsp;The job is pending</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/concourse_pending.png" alt="concourse pending"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5308" href="#d0e5308"></a><p class="title"><b>Figure&nbsp;8.11.&nbsp;Job is pending in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/job_running.png" alt="job running"></div></div></div><br class="figure-break"><p>&nbsp;
&nbsp;</p><div class="figure"><a name="d0e5319" href="#d0e5319"></a><p class="title"><b>Figure&nbsp;8.12.&nbsp;Job is running in the main screen</b></p><div class="figure-contents"><div class="mediaobject"><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-pipelines/master/docs-sources/src/main/asciidoc/images/concourse/running_pipeline.png" alt="running pipeline"></div></div></div><br class="figure-break"></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="multi_concourse-pipeline-cf.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="multi__spring_cloud_pipelines.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="multi__jenkins_pipeline_common.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">7.&nbsp;Concourse Pipeline (Cloud Foundry)&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="multi_spring-cloud-pipelines.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;9.&nbsp;Jenkins Pipeline (Common)</td></tr></table></div></body></html>